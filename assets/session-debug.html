<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>会话调试工具</title>
    <link rel="preload" href="./hls.min.js" as="script" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .log-pre {
        background: #1e293b !important;
        color: #f1f5f9 !important;
        font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace !important;
        line-height: 1.4 !important;
      }
      .log-success {
        background: #ecfdf5 !important;
        border-left: 3px solid #10b981 !important;
      }
      .log-error {
        background: #fef2f2 !important;
        border-left: 3px solid #ef4444 !important;
      }
    </style>
    <script defer src="./hls.min.js"></script>
  </head>
  <body class="bg-gray-100 text-gray-900 font-sans p-4">
    <h1 class="text-2xl font-semibold mb-4">EchoPlayer 会话调试控制台</h1>

    <!-- 主网格布局 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4">
      <!-- 左栏：配置和创建 -->
      <div class="space-y-4">
        <!-- 环境设置 -->
        <section
          class="bg-white border border-gray-300 rounded-lg p-4 shadow-sm"
        >
          <h2 class="text-lg font-medium mb-3">环境设置</h2>
          <div class="space-y-3">
            <label class="block text-sm">
              <span class="mb-1 block">API 基础地址</span>
              <input
                id="apiBase"
                placeholder="http://localhost:8799/api/v1"
                class="w-full text-sm px-2.5 py-2 rounded-md border border-slate-300"
              />
            </label>
            <label class="block text-sm">
              <span class="mb-1 block">默认视频文件路径</span>
              <input
                id="defaultFile"
                placeholder="/path/to/video/file.mp4"
                class="w-full text-sm px-2.5 py-2 rounded-md border border-slate-300"
              />
            </label>
            <button
              id="checkHealth"
              class="w-full text-sm px-2.5 py-2 rounded-md border border-slate-700 bg-slate-700 text-white font-semibold cursor-pointer hover:bg-slate-600 transition-colors"
            >
              检查服务器状态
            </button>
          </div>
        </section>

        <!-- 创建会话 -->
        <section
          class="bg-white border border-gray-300 rounded-lg p-4 shadow-sm"
        >
          <h2 class="text-lg font-medium mb-3">创建会话</h2>
          <div class="space-y-3">
            <label class="block text-sm">
              <span class="mb-1 block">视频文件路径</span>
              <input
                id="filePath"
                required
                class="w-full text-sm px-2.5 py-2 rounded-md border border-slate-300"
              />
            </label>
            <label class="block text-sm">
              <span class="mb-1 block">初始时间 (秒)</span>
              <input
                id="initialTime"
                type="number"
                min="0"
                step="0.1"
                value="0"
                class="w-full text-sm px-2.5 py-2 rounded-md border border-slate-300"
              />
            </label>

            <!-- 高级选项 -->
            <details class="border border-gray-200 rounded p-2">
              <summary class="cursor-pointer text-sm font-medium">
                高级选项
              </summary>
              <div class="space-y-2 mt-2">
                <label class="block text-xs">
                  <span class="mb-1 block">视频编码器 (video_codec)</span>
                  <input
                    id="videoCodec"
                    placeholder="例如: libx264"
                    class="w-full text-xs px-2 py-1.5 rounded border border-slate-300"
                  />
                </label>
                <div class="grid grid-cols-2 gap-2">
                  <label class="block text-xs">
                    <span class="mb-1 block">编码预设</span>
                    <input
                      id="videoPreset"
                      placeholder="veryfast"
                      class="w-full text-xs px-2 py-1.5 rounded border border-slate-300"
                    />
                  </label>
                  <label class="block text-xs">
                    <span class="mb-1 block">视频码率</span>
                    <input
                      id="videoBitrate"
                      placeholder="2500k"
                      class="w-full text-xs px-2 py-1.5 rounded border border-slate-300"
                    />
                  </label>
                </div>
                <div class="grid grid-cols-2 gap-2">
                  <label class="block text-xs">
                    <span class="mb-1 block">分片时长</span>
                    <input
                      id="hlsTime"
                      type="number"
                      min="0"
                      step="0.1"
                      class="w-full text-xs px-2 py-1.5 rounded border border-slate-300"
                    />
                  </label>
                  <label class="block text-xs">
                    <span class="mb-1 block">窗口时长</span>
                    <input
                      id="windowDuration"
                      type="number"
                      min="0"
                      step="0.1"
                      class="w-full text-xs px-2 py-1.5 rounded border border-slate-300"
                    />
                  </label>
                </div>
              </div>
            </details>

            <button
              id="createSession"
              class="w-full text-sm px-2.5 py-2 rounded-md border border-blue-600 bg-blue-600 text-white font-semibold cursor-pointer hover:bg-blue-700 transition-colors"
            >
              创建并播放
            </button>
          </div>
        </section>
      </div>

      <!-- 中栏：会话控制和播放器 -->
      <div class="space-y-4">
        <!-- 会话控制 -->
        <section
          class="bg-white border border-gray-300 rounded-lg p-4 shadow-sm"
        >
          <h2 class="text-lg font-medium mb-3">会话控制</h2>
          <p id="currentSession" class="text-sm mb-3 p-2 bg-gray-50 rounded">
            当前会话: 未创建
          </p>

          <div class="space-y-3">
            <!-- 会话信息按钮组 -->
            <div class="grid grid-cols-2 gap-2">
              <button
                id="refreshInfo"
                class="text-xs px-2 py-1.5 rounded border border-slate-700 bg-slate-700 text-white font-medium cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-600 transition-colors"
                disabled
              >
                会话信息
              </button>
              <button
                id="refreshPlaylist"
                class="text-xs px-2 py-1.5 rounded border border-slate-700 bg-slate-700 text-white font-medium cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-600 transition-colors"
                disabled
              >
                播放列表
              </button>
              <button
                id="refreshPlaylistInfo"
                class="text-xs px-2 py-1.5 rounded border border-slate-700 bg-slate-700 text-white font-medium cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-600 transition-colors"
                disabled
              >
                列表详情
              </button>
              <button
                id="listSessions"
                class="text-xs px-2 py-1.5 rounded border border-slate-700 bg-slate-700 text-white font-medium cursor-pointer hover:bg-slate-600 transition-colors"
              >
                所有会话
              </button>
            </div>

            <button
              id="getStats"
              class="w-full text-xs px-2 py-1.5 rounded border border-slate-700 bg-slate-700 text-white font-medium cursor-pointer hover:bg-slate-600 transition-colors"
            >
              会话统计
            </button>

            <!-- Seek 控制 -->
            <div class="grid grid-cols-2 gap-2 items-end">
              <label class="block text-xs">
                <span class="mb-1 block">Seek (秒)</span>
                <input
                  id="seekTime"
                  type="number"
                  min="0"
                  step="0.1"
                  class="w-full text-xs px-2 py-1.5 rounded border border-slate-300"
                />
              </label>
              <button
                id="seekButton"
                class="text-xs px-2 py-1.5 rounded border border-blue-600 bg-blue-600 text-white font-medium cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed hover:bg-blue-700 transition-colors"
                disabled
              >
                执行 Seek
              </button>
            </div>

            <!-- 时间上报控制 -->
            <div class="grid grid-cols-2 gap-2 items-end">
              <label class="block text-xs">
                <span class="mb-1 block">播放时间 (秒)</span>
                <input
                  id="reportTime"
                  type="number"
                  min="0"
                  step="0.1"
                  class="w-full text-xs px-2 py-1.5 rounded border border-slate-300"
                />
              </label>
              <button
                id="reportButton"
                class="text-xs px-2 py-1.5 rounded border border-blue-600 bg-blue-600 text-white font-medium cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed hover:bg-blue-700 transition-colors"
                disabled
              >
                更新时间
              </button>
            </div>

            <button
              id="deleteSession"
              class="w-full text-sm px-2.5 py-2 rounded-md border border-red-600 bg-red-600 text-white font-semibold cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed hover:bg-red-700 transition-colors"
              disabled
            >
              删除会话
            </button>
          </div>
        </section>

        <!-- 播放器 -->
        <section
          class="bg-white border border-gray-300 rounded-lg p-4 shadow-sm"
        >
          <h2 class="text-lg font-medium mb-3">播放器</h2>
          <video
            id="video"
            controls
            class="w-full max-h-[250px] bg-slate-900 rounded-md"
          ></video>
          <p id="playerStatus" class="text-sm mt-2 p-2 bg-gray-50 rounded">
            播放器尚未加载播放列表
          </p>
        </section>
      </div>

      <!-- 右栏：调试日志（占满高度） -->
      <div class="lg:col-span-2 xl:col-span-1">
        <section
          class="bg-white border border-gray-300 rounded-lg p-4 shadow-sm h-full"
        >
          <h2 class="text-lg font-medium mb-3">调试日志</h2>
          <div
            id="log"
            class="h-96 border border-gray-300 rounded-md p-3 bg-white"
          ></div>
        </section>
      </div>
    </div>

    <script>
      const apiBaseInput = document.getElementById("apiBase");
      const defaultFileInput = document.getElementById("defaultFile");
      const filePathInput = document.getElementById("filePath");
      const initialTimeInput = document.getElementById("initialTime");
      const videoCodecInput = document.getElementById("videoCodec");
      const videoPresetInput = document.getElementById("videoPreset");
      const videoBitrateInput = document.getElementById("videoBitrate");
      const hlsTimeInput = document.getElementById("hlsTime");
      const windowDurationInput = document.getElementById("windowDuration");
      const createButton = document.getElementById("createSession");
      const checkHealthButton = document.getElementById("checkHealth");
      const refreshInfoButton = document.getElementById("refreshInfo");
      const refreshPlaylistButton = document.getElementById("refreshPlaylist");
      const refreshPlaylistInfoButton = document.getElementById(
        "refreshPlaylistInfo"
      );
      const listSessionsButton = document.getElementById("listSessions");
      const getStatsButton = document.getElementById("getStats");
      const seekInput = document.getElementById("seekTime");
      const seekButton = document.getElementById("seekButton");
      const reportInput = document.getElementById("reportTime");
      const reportButton = document.getElementById("reportButton");
      const deleteButton = document.getElementById("deleteSession");
      const currentSessionLabel = document.getElementById("currentSession");
      const videoElement = document.getElementById("video");
      const playerStatus = document.getElementById("playerStatus");
      const logContainer = document.getElementById("log");

      let currentSessionId = null;
      let currentPlaylistUrl = null;
      let hlsPlayer = null;

      function defaultApiBase() {
        const origin = window.location.origin;
        const fallback = "http://127.0.0.1:8799";
        const base = origin && origin !== "null" ? origin : fallback;
        return `${base.replace(/\/$/, "")}/api/v1`;
      }

      function getApiBase() {
        const value = apiBaseInput.value.trim();
        if (!value) {
          return defaultApiBase();
        }
        return value.replace(/\/?$/, "");
      }

      function buildApiUrl(path) {
        const base = getApiBase();
        return base + (path.startsWith("/") ? path : `/${path}`);
      }

      function log(action, data, isError = false) {
        const entry = document.createElement("div");
        const bgClass = isError ? "log-error" : "log-success";
        entry.className = `mb-2 pb-3 ${bgClass} rounded-md p-2`;
        const timestamp = new Date().toLocaleTimeString();

        // 优化时间戳和动作文本的颜色
        const headerColor = isError ? "text-red-800" : "text-green-800";
        const statusIcon = isError ? "❌" : "✅";

        entry.innerHTML = `<div class="text-sm font-semibold ${headerColor} mb-2 flex items-center gap-1">
          <span>${statusIcon}</span>
          <span>[${timestamp}] ${action}</span>
        </div><pre class="log-pre text-sm p-3 rounded-md overflow-auto max-h-32 whitespace-pre-wrap border border-slate-600">${
          typeof data === "string" ? data : JSON.stringify(data, null, 2)
        }</pre>`;
        logContainer.prepend(entry);
      }

      async function jsonRequest(method, path, payload) {
        const options = { method, headers: { Accept: "application/json" } };
        if (payload) {
          options.headers["Content-Type"] = "application/json";
          options.body = JSON.stringify(payload);
        }
        const response = await fetch(buildApiUrl(path), options);
        const text = await response.text();
        let parsed;
        try {
          parsed = text ? JSON.parse(text) : {};
        } catch (error) {
          log("解析响应失败", text, true);
          throw error;
        }
        if (!response.ok) {
          const message = parsed?.detail || response.statusText;
          throw new Error(message || "请求失败");
        }
        return parsed;
      }

      async function textRequest(path) {
        const response = await fetch(buildApiUrl(path), { cache: "no-store" });
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        return response.text();
      }

      function setSessionState(sessionId, playlistUrl) {
        currentSessionId = sessionId;
        currentPlaylistUrl = playlistUrl;
        const label = sessionId ? `当前会话: ${sessionId}` : "当前会话: 未创建";
        currentSessionLabel.textContent = label;
        const hasSession = Boolean(sessionId);
        refreshInfoButton.disabled = !hasSession;
        refreshPlaylistButton.disabled = !hasSession;
        refreshPlaylistInfoButton.disabled = !hasSession;
        seekButton.disabled = !hasSession;
        reportButton.disabled = !hasSession;
        deleteButton.disabled = !hasSession;
      }

      function loadPlaylist(url) {
        if (!url) {
          playerStatus.textContent = "未找到播放列表 URL";
          return;
        }
        const playlist = new URL(url, getApiBase() + "/").toString();
        if (hlsPlayer) {
          hlsPlayer.destroy();
          hlsPlayer = null;
        }
        if (Hls.isSupported()) {
          hlsPlayer = new Hls({ enableWorker: true, lowLatencyMode: true });
          hlsPlayer.on(Hls.Events.ERROR, (_, data) => {
            log("HLS 播放错误", data, true);
            playerStatus.textContent = `HLS 错误: ${data?.details || "未知"}`;
          });
          hlsPlayer.loadSource(playlist);
          hlsPlayer.attachMedia(videoElement);
          playerStatus.textContent = `正在播放: ${playlist}`;
        } else if (videoElement.canPlayType("application/vnd.apple.mpegurl")) {
          videoElement.src = playlist;
          playerStatus.textContent = `正在播放 (原生 HLS): ${playlist}`;
        } else {
          playerStatus.textContent = "当前浏览器不支持 HLS";
        }
      }

      async function handleCreate() {
        const payload = {
          file_path: filePathInput.value.trim(),
          initial_time: parseFloat(initialTimeInput.value) || 0,
        };
        if (!payload.file_path) {
          alert("请填写文件路径");
          return;
        }
        if (videoCodecInput.value.trim())
          payload.video_codec = videoCodecInput.value.trim();
        if (videoPresetInput.value.trim())
          payload.video_preset = videoPresetInput.value.trim();
        if (videoBitrateInput.value.trim())
          payload.video_bitrate = videoBitrateInput.value.trim();
        if (hlsTimeInput.value)
          payload.hls_time = parseFloat(hlsTimeInput.value);
        if (windowDurationInput.value)
          payload.window_duration = parseFloat(windowDurationInput.value);
        try {
          createButton.disabled = true;
          const response = await jsonRequest(
            "POST",
            "/session/create",
            payload
          );
          log("创建会话", response);
          setSessionState(response.session_id, response.playlist_url);
          loadPlaylist(response.playlist_url);
        } catch (error) {
          log("创建会话失败", error.message, true);
          alert(`创建会话失败: ${error.message}`);
        } finally {
          createButton.disabled = false;
        }
      }

      async function handleInfo() {
        if (!currentSessionId) return;
        try {
          const data = await jsonRequest(
            "GET",
            `/session/${currentSessionId}/info`
          );
          log("会话信息", data);
        } catch (error) {
          log("获取会话信息失败", error.message, true);
        }
      }

      async function handlePlaylist() {
        if (!currentSessionId) return;
        try {
          const text = await textRequest(
            `/session/${currentSessionId}/playlist.m3u8`
          );
          log("播放列表", text);
        } catch (error) {
          log("获取播放列表失败", error.message, true);
        }
      }

      async function handlePlaylistInfo() {
        if (!currentSessionId) return;
        try {
          const data = await jsonRequest(
            "GET",
            `/session/${currentSessionId}/playlist-info`
          );
          log("播放列表详情", data);
        } catch (error) {
          log("获取播放列表详情失败", error.message, true);
        }
      }

      async function handleSeek() {
        if (!currentSessionId) return;
        const time = parseFloat(seekInput.value);
        if (Number.isNaN(time)) {
          alert("请输入有效的 seek 时间");
          return;
        }
        try {
          const data = await jsonRequest(
            "POST",
            `/session/${currentSessionId}/seek`,
            { time_seconds: time }
          );
          log("Seek 结果", data);
          if (data.playlist_updated) {
            loadPlaylist(currentPlaylistUrl);
          }
        } catch (error) {
          log("Seek 失败", error.message, true);
        }
      }

      async function handleReport() {
        if (!currentSessionId) return;
        const time = parseFloat(reportInput.value);
        if (Number.isNaN(time)) {
          alert("请输入有效的播放时间");
          return;
        }
        try {
          const data = await jsonRequest(
            "POST",
            `/session/${currentSessionId}/update-time`,
            { current_time: time }
          );
          log("更新播放时间", data);
        } catch (error) {
          log("更新播放时间失败", error.message, true);
        }
      }

      async function handleDelete() {
        if (!currentSessionId) return;
        if (!confirm("确认删除当前会话吗?")) return;
        try {
          const data = await jsonRequest(
            "DELETE",
            `/session/${currentSessionId}`
          );
          log("删除会话", data);
          setSessionState(null, null);
          if (hlsPlayer) {
            hlsPlayer.destroy();
            hlsPlayer = null;
          }
          videoElement.removeAttribute("src");
          videoElement.load();
          playerStatus.textContent = "会话已删除";
        } catch (error) {
          log("删除会话失败", error.message, true);
        }
      }

      async function handleListSessions() {
        try {
          const data = await jsonRequest("GET", "/session/list");
          log("会话列表", data);
        } catch (error) {
          log("获取会话列表失败", error.message, true);
        }
      }

      async function handleStats() {
        try {
          const data = await jsonRequest("GET", "/session/stats");
          log("会话统计", data);
        } catch (error) {
          log("获取会话统计失败", error.message, true);
        }
      }

      async function handleHealthCheck() {
        try {
          const data = await jsonRequest("GET", "/session/stats");
          log("健康检查", { message: "服务器可用", stats: data });
        } catch (error) {
          log("健康检查失败", error.message, true);
        }
      }

      createButton.addEventListener("click", handleCreate);
      checkHealthButton.addEventListener("click", handleHealthCheck);
      refreshInfoButton.addEventListener("click", handleInfo);
      refreshPlaylistButton.addEventListener("click", handlePlaylist);
      refreshPlaylistInfoButton.addEventListener("click", handlePlaylistInfo);
      listSessionsButton.addEventListener("click", handleListSessions);
      getStatsButton.addEventListener("click", handleStats);
      seekButton.addEventListener("click", handleSeek);
      reportButton.addEventListener("click", handleReport);
      deleteButton.addEventListener("click", handleDelete);

      defaultFileInput.addEventListener("change", () => {
        filePathInput.value = defaultFileInput.value.trim();
      });

      document.addEventListener("DOMContentLoaded", () => {
        apiBaseInput.value = defaultApiBase();
        const defaultFile = defaultFileInput.value.trim();
        if (defaultFile) {
          filePathInput.value = defaultFile;
        }
      });
    </script>
  </body>
</html>
